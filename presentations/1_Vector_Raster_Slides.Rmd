---
title: "Vector & Raster Data"
author: "Landscape Genetic Data Analysis Workshop"
date: "SCENE Scotland, October, 2016"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_knit$set(global.par = TRUE)
```

```{r echo=FALSE}
par( bg=NA )
```



# Vector Objects

## The `sp` Library

A package containing data structure and support functions for point, line, and polygon data (Pebesma *et al.* 2005, Bivand *et al.* 2013)

- Points  
- Lines  
- Polygons  



## Coordinates 

Spatial coordinates in R can be defined using normal data structures.

```{r}
Latitude <- c( 47.0379,48.7491,43.0308,37.5407, 39.7392)
Longitude <- c(-122.9007,-122.4781,-93.6319,-77.43609,-104.9903)
coords <- cbind( Longitude, Latitude )
rownames(coords) <- c("Olympia","Bellingham","Ames","Richmond", "Denver")
colnames(coords) <- c("Longitude","Latitude")
coords
```


## Coordinates 

However, for a set of corrdinates, there is more metadata that needs to be associated with the coordinates that *suggest* slightly more complicated data structures.

```{r message=FALSE, warning=FALSE}
library(sp)
pts <- SpatialPoints( coords )
summary(pts)
```

## Coordinates


```{r}
pts
bbox(pts)
```


## SpatialPointsDataFrame

In addition to just the raw spatial data, a *SpatialPointsDataFrame* can be derived that has additional information associated with each point.  

```{r}
df <- data.frame( Name=rownames(coords), Years = c(17,3,2,12,0))
points_df <- SpatialPointsDataFrame(coords=coords, data = df )
points_df
```

## Accessing information within *SpatialPointsDataFrame* objects

Accessing data within these objects follows standard techniques.

```{r}
points_df$Name[3]
points_df[c(1,4,3,2), ]
```



## Coordiante Reference Systems

A mathematical representation of coordiante space used to describe the non-flat (and non-spheroid) shape of the earth.

```{r}
proj <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
proj4string(pts) <- CRS(proj)
pts
```


## Coordinate Reference System Components 

There are two main components to coordinate refrences systems:

* Ellipsoid - Describe the physical shape of the earth
* Projection - A way to represent the ellipsoid shape as a 2-dimensional object



## Ellipsoids

Commonly used models of earth's shape as an ellipsoid include:  

* **NAD27** - North American Datum of 1927 based upon land surveys  
* **NAD83/GRS80** - Is based upon satellite data measuring the radial distance of the earth.
* **WGS84** - World Geodetic System refined initially for military use during the development of GPS systems.


## Projections

A way of converting the spherical coordinates on an ellipsoid, such as longitude and latitude or UTM, into 2-dimensional coordinates that we can use to map items on the surface of the earth.  All projectsion produce bias in area, distance, and/or shape.

> - **Aximuthal**: A projection of coordiantes onto a plane that is tangential to the surface of the earth (typically a the pole or equator).  
> - **Cylindrical**: Projects the surface of the earth onto a cylinder, which is 'unrooled' like a large map.  This is why Greenland is so large...
> - **Conic**: Project coordinates onto a cone.


## Equatorial Projections

```{r projections1, warning=FALSE, message=FALSE, echo=FALSE, fig.align="center"}
library(maps)
par(mfrow=c(1,3))
map("world",proj="mercator", ylim=c(38,70), xlim=c(-10,25))
map("world",proj="mollweide", ylim=c(38,70), xlim=c(-10,25))
map("world",proj="gilbert", ylim=c(38,70), xlim=c(-10,25))
par(mfrow=c(1,1))
```

Mercator, Mollweide, & Gilbert projections of the same map


## Cylindrical Projections



```{r echo=FALSE,fig.align="center"}
par(mfrow=c(1,3))
map("world",proj="orthographic", ylim=c(38,70), xlim=c(-10,25))
map("world",proj="stereographic", ylim=c(38,70), xlim=c(-10,25))
map("world",proj="gnomonic", ylim=c(38,70), xlim=c(-10,25))
par(mfrow=c(1,1))
```

Orthographic, Stereographic, & Gnomonic projections.



## Conical Projections

```{r echo=FALSE,fig.align="center"}
par(mfrow=c(1,3))
map("world",proj="conic", par=54, ylim=c(38,70), xlim=c(-10,25))
map("world",proj="albers", par=c(7.5,54), ylim=c(38,70), xlim=c(-10,25))
map("world",proj="lambert", par=c(7.5,54), ylim=c(38,70), xlim=c(-10,25))
par(mfrow=c(1,1))
```

Conic, Albers Equal Area, and Lambert projections tangental to the center of the map.


## Coordinate Systems
In R, we typically are dealing with a combination of data that we've collected and that we've attained from some other provider.  In most GIS applications, the coordinate systems we encounter are either:  

> - UTM (Universal Transverse Mercator) measuring the distance from the prime meridian for the x-coordinate and the distance from the equator (often called northing in the northern hemisphere) for the y-coordinate. These distances are in meters and the globe is divided into 60 zones, each of which is 6 degrees in width.
> - Geographic coordinate systems use longitude and latitude.  For historical purposes these are unfortunately reported in degrees, minutes, seconds, a temporal abstraction that is both annoying and a waste of time (IMHO).  Decimal degrees, while less easy to remember, are easier to work with in R.


## Reprojecting Coordinate Systems | Not just assigning new `proj4string` valuse {.build}

```{r}
pts
```


## Reprojecting Coordinate Systems | Not just assigning new `proj4string` values

```{r}
pts.utm <- spTransform(pts, CRS("+proj=utm +zone=12 +datum=WGS84"))
summary( pts.utm )
```


## Reprojecting Coordinate Systems

```{r eval=TRUE,echo=FALSE, message=FALSE, fig.cap="Population locations in (A) longitude and latitude and (B) Universal Transverse Mercator coordinate systems.",warning=FALSE, fig.align="center"}
library(cowplot)
df.latlong <- data.frame( coordinates(pts) )
names(df.latlong) <- c("Longitude","Latitude")
plot.lalong <- ggplot( df.latlong, aes(Longitude,Latitude)) + geom_point() + theme(axis.text.x=element_text(angle=90,hjust=1)) 

df.utm <- data.frame( coordinates(pts.utm))
names(df.utm) <- c("Easting","Northing")
plot.utm <- ggplot( df.utm, aes(Easting,Northing)) + geom_point() + theme(axis.text.x=element_text(angle=90,hjust=1)) 

plot_grid( plot.lalong, plot.utm, labels=c("A","B"), align="h")
```


## EPSG Codes | Shortcuts to common projections

EPSG Geodetic Parameter Dataset defines coordinate reference systems and transformations and is available at http://www.pesg.org.  EPSG codes are shorthand for more complete definitions.

```{r}
uk_grid <- "+init=epsg:27700"
google_grid <- "+init=epsg:3857"
latlon_grid <- "+init=epsg:4236"
CRS(uk_grid)
```






## *Line* Objects

A collection of point can be defined as a *Line* object and elevated to *SpatialLines* and *SpatialLinesDataFrame* objects.

```{r}
coords
```


## *Line* Objects

*Line* objects are constructed from at least a pair of points.

```{r}
l1 <- Line( coords[c(1,2),])
l2 <- Line( coords[c(2,3),])
l3 <- Line( coords[c(3,4),])
l3
```


## *Lines* Objects

```{r}
moves1 <- Lines( list(l1), ID="BS")
moves2 <- Lines( list(l2), ID="Postdoc")
moves3 <- Lines( list(l3), ID="Job")
moves1
```

## *SpatialLines* Objects

```{r}
spatial_lines <- SpatialLines( list( moves1, moves2, moves3 ),
                               proj4string = CRS(latlon_grid) )
summary( spatial_lines )
```


## *SpatialLinesDataFrame* Objects {.smaller}

```{r}
df <- data.frame( Year=c(1992,2000,2004), Institution=factor( c("WWU","ISU","VCU")) )
rownames(df) <- c("BS","Postdoc", "Job")
spatial_lines_df <- SpatialLinesDataFrame( spatial_lines, data=df )
summary( spatial_lines_df )
```

(*n.b.*, rownames of data.frame must match ID of *Lines* objects)



## Spatial Polygons

Polygons are simply a collection of lines, that loop back onto itself to make a closed loop. 


```{r}
poly_lon <- c( Longitude, Longitude[1])
poly_lat <- c( Latitude, Latitude[1] ) 
poly_coords <- cbind( poly_lon, poly_lat)
poly_coords
```


## Spatial Polygons

```{r}
P <- Polygon( poly_coords )
P
```

## *SpatialPolygon* Objects

In a similar fashion, we can specfify coordiante systems and datum on polygons.

```{r}
polys <- Polygons( list(P), ID="institution Polygon")
spatial_polys <- SpatialPolygons( list( polys ) )
proj4string(spatial_polys) <- CRS( latlon_grid )
summary(spatial_polys)
```

## Plotting

```{r}
plot( spatial_polys, axes=TRUE , xlab="Longitude (W)", ylab="Latitude (N)")
```



# Raster Data

## Grids of data: Rasters 

```{r chunk-raster, message=FALSE,warning=FALSE}
library(raster)
r <- matrix(runif(10000),nrow=100)
rnd <- raster( r )
rnd
```


## Grids of data: Rasters 


```{r}
plot(rnd)
```


## Public Repositories

There are also many available repositories for raster data including Open Source, Governmental, and Municipal locations.  One common source for these data is that of http://worldclim.org.

```{r echo=FALSE, fig.width=16}
knitr::include_graphics("../media/WorldClimTiles.png",dpi = 120)
```


## BioClimatic Data {.smaller}

Calculated raster layers (derived from temperature & precipitation data) thought to have biological relevance.

```{r bioclim, echo=FALSE}
df <- data.frame( Layer=paste( rep("BIO",19), 1:19, sep=""))
df$Description = c("Annual Mean Temperature", "Mean Diurnal Range (Mean of monthly (max temp - min temp))", "Isothermality (BIO2/BIO7 * 100)", "Temperature Seasonality (standard deviation * 100)", "Max Temperature of Warmest Month","Min Temperature of Coldest Month", "Temperature Annual Range (BIO5-BIO6)","Mean Temperature of Wettest Quarter","Mean Temperature of Driest Quarter","Mean Temperature of Warmest Quarter","Mean Temperature of Coldest Quarter","Annual Precipitation","Precipitation of Wettest Month","Precipitation of Driest Month","Precipitation Seasonality (Coefficient of Variation)","Precipitation of Wettest Quarter","Precipitation of Driest Quarter","Precipitation of Warmest Quarter","Precipitation of Coldest Quarter")
knitr::kable( df, booktabs=TRUE, caption="", longtable=TRUE, format="html" )
```


## Raster Data Formats

Common file formats include:

> - **GeoTIFF**: A public domain image file (derived from TIFF) that has been embedded with additional georeferencing metadata.
> - **BIL**: A Binary InterLeaved file format with associated header file.





## Raster Example

I downloaded the elevation (alt) 

```{r}
library(raster)
dem <- raster("../spatial_data/alt.tif")
dem
```


## Raster Example

```{r}
plot(dem, xlab="Longitude", ylab="Latitude")
```

## Raster Getting/Setting Data

```{r}
dim( dem ) 
```

```{r}
dem[1,1800]
```




# GGPlot Plotting




## Citations {.hanging}

Pebesma, E.J., R.S. Bivand, 2005. Classes and methods for spatial data in R. *R News*, **5**, 2,  http://cran.r-project.org/doc/Rnews/.  

Roger S. Bivand, Edzer Pebesma, Virgilio Gomez-Rubio, 2013. *Applied spatial data analysis
  with R*, Second edition. Springer, NY. http://www.asdar-book.org/
